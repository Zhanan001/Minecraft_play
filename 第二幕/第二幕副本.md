我将为你制定一份完整的 **《第二幕：四大区域副本管理规范》**。这份规范将定义副本从创建、运行到销毁的全生命周期管理规则，确保技术实现统一、玩家体验可控、服务器性能稳定。

## **第一章：副本核心定义与分类**

### **1.1 副本类型（按第二幕设计）**


| 类型               | 对应区域                     | 核心性质                                  | 玩家准入                                    | 实例模型                   |
| :----------------- | :--------------------------- | :---------------------------------------- | :------------------------------------------ | :------------------------- |
| **探险型区域副本** | 焦灼荒地、霜语山脉、幽影沼泽 | **队伍专属，进度独立**。核心玩法。        | 2-5人队伍，队长持有“区域指引罗盘”         | 每个队伍一个独立世界实例   |
| **解谜型剧情副本** | 晶化洞窟                     | **个人/队伍专属，含道德抉择**。剧情高潮。 | 个人必须已获得至少2个其他区域的“记忆残像” | 每个符合条件者进入独立实例 |
| **公共动态副本**   | （备用）尘封小径后续扩展区   | **全服玩家共享，分线负载**。用于日常。    | 任意玩家，按负载动态分线                    | 单条分线承载上限20人       |

### **1.2 副本技术栈**

* **核心插件**：`DungeonsXL` (副本实例管理) + `Multiverse-Core` (世界模板管理)
* **脚本驱动**：`Denizen` (剧情、任务流) 或 `DungeonsXL` 原生脚本
* **怪物系统**：`MythicMobs`
* **进度保存**：`DungeonsXL` 内置 + `MySQL` (关键选择记录)
* **权限与区域**：`WorldGuard`, `LuckPerms` (上下文权限)

---

## **第二章：副本生命周期管理规范**

### **2.1 阶段一：创建与准入**

#### **A. 前置条件检查 (脚本实现)**

玩家与对应传送门交互时，执行以下检查链：

```yaml
# Denizen 脚本示例：焦灼荒地准入检查
scorched_access_check:
  type: world
  debug: false
  events:
    on player right clicks block:portal:
      - if <player.has_flag[has_scorched_compass]> {
          # 检查队伍
          - run “party check <player> min:2 max:5”
          - if <server.last_command_output.contains[VALID]> {
              - run “dxl play <player> scorched_wastes”
              }
            else {
              - narrate “<&c>你需要一支2-5人的队伍才能激活传送门。”
              }
          }
        else {
          - narrate “<&c>你需要从大法师阿尔图处获得‘焦灼荒地指引罗盘’。”
          }
```

#### **B. 实例创建流程**

1. **队列检查**：系统检查当前是否有可重复利用的“冷却中”副本实例。
2. **世界生成**：从模板世界 `world_dxl_scorched_template` 复制，生成唯一ID的世界，如 `scorched_wastes_7a3b1c`。
3. **队伍绑定**：将副本世界ID与触发队伍的**队伍UUID**绑定，写入数据库 `active_dungeons` 表。
4. **初始化**：加载副本脚本，重置所有机关状态，设置游戏规则（如 `keepInventory:true`）。
5. **传送**：将队伍全体成员传送至副本世界的 **起始安全区** (`start` 坐标)。

#### **C. 准入规则表**


| 规则项            | 焦灼/霜语/幽影                 | 晶化洞窟                                   |
| :---------------- | :----------------------------- | :----------------------------------------- |
| **最低/最高人数** | 2 / 5                          | 1 / 3                                      |
| **前置任务**      | 完成《能量采样》，拥有对应罗盘 | 拥有至少2个其他区域的“记忆残像”          |
| **职业推荐**      | 无强制，但任务设计鼓励搭配     | 强烈推荐队伍包含**匠师**与**元术士**       |
| **冷却时间**      | 个人每周目通关后1小时          | 个人永久性选择，通关后无法再次进入同一分支 |

### **2.2 阶段二：运行与进度管理**

#### **A. 副本内通用规则**

* **时间限制**：所有副本**统一为2小时（7200秒）**。剩余时间每15分钟在行动栏提示。
* **生命制度**：采用 **“团队共享生命池”**。默认3条生命，全队共用。生命耗尽全队强制传出，副本标记为失败。
* **进度保存点**：
  1. **阶段里程碑**：完成“净化信标”、“修复桥梁”等关键阶段后，自动保存。
  2. **BOSS战**：进入BOSS战区域时自动保存。
  3. **玩家退出**：玩家通过命令 `/dungeon leave` 退出时，保存其个人进度（如任务物品），队伍进度保留在副本中。

#### **B. 断线重连规则**

1. **窗口期**：玩家掉线后有 **10分钟** 窗口期重新连接回原副本。
2. **重连方式**：重新登录后，在出生点使用NPC或命令 (`/dungeon rejoin`) 传送回未过期的副本实例。
3. **数据同步**：重连后，同步其个人任务进度、背包任务物品。

#### **C. 关键进度触发器实现规范**

所有剧情推进必须通过 **脚本事件** 触发，禁止依赖玩家偶然行为。

```yaml
# 示例：焦灼荒地 - 净化信标守护事件
event_defend_beacon_a:
  type: defend
  location: -20,64,0
  radius: 8
  target: ENTITY:armor_stand[beacon_tag] # 目标是带有标签的盔甲架
  waves: 3
  mobs_per_wave: “magma_aberration:2-3”
  wave_interval_ticks: 600 # 30秒
  success_actions:
    - setblock -20,64,0 beacon # 将盔甲架替换为真正的信标方块
    - broadcast sound entity.player.levelup
    - give @players_in_radius[10] “净化的能量核心” 1
  fail_actions:
    - effect clear @players_in_radius[15] # 清除玩家效果
    - spawn particle cloud -20,65,0 spread:1.5 count:50
    - message “&c净化失败！能量污染爆发了！”
    # 不重置事件，允许玩家重新触发
```

### **2.3 阶段三：完成、退出与销毁**

#### **A. 完成条件与分支**


| 完成状态     | 触发条件                    | 结果                                 |
| :----------- | :-------------------------- | :----------------------------------- |
| **完美通关** | 击败区域BOSS + 解读纪年石碑 | 获得“记忆残像”、全额奖励、解锁后续 |
| **普通完成** | 击败区域BOSS                | 获得基础奖励，无“记忆残像”         |
| **失败**     | 团队生命耗尽 或 超时        | 无奖励，记录失败次数                 |

#### **B. 结算与奖励发放流程**

1. **延迟结算**：BOSS死亡后，有**10秒**无敌时间供玩家复活、集合。
2. **全局公告**：首次解读石碑时，触发全服金色公告。
3. **奖励发放**：通过 `DungeonsXL` 的 `rewards` 系统发放，**必须记录到数据库**。
4. **个人抉择记录**：晶化洞窟的选择 (`attack`/`observe`) 必须写入玩家的 `player_data` 表，用于决定第三幕阵营任务。

#### **C. 副本销毁与资源回收**

1. **销毁触发条件**（满足任一即进入销毁队列）：
   * 所有玩家正常离开且副本完成/失败。
   * 副本持续时间到期。
   * 副本内无玩家超过 **15分钟**。
2. **销毁流程**：
   * 将关键数据（如完成状态、玩家贡献）写入日志。
   * 通过 `Multiverse` 卸载世界 `mv unload {DUNGEON_WORLD}`。
   * 延迟 **5分钟** 后，删除世界文件夹 (`mv delete {DUNGEON_WORLD}`)。
   * 从 `active_dungeons` 数据库表中移除记录。

---

## **第三章：配置与脚本编写规范**

### **3.1 文件结构与命名**

```
plugins/DungeonsXL/
├── dungeons/                    # 主配置
│   ├── 1_act2_scorched.yml
│   ├── 2_act2_frost.yml
│   ├── 3_act2_swamp.yml
│   └── 4_act2_crystal.yml
├── scripts/                     # 副本逻辑脚本
│   ├── act2_scorched_main.dscript
│   └── ...
└─── templates/                  # (可选) 地图模板文件
```

**命名规则**：`[幕次]_[区域]_[名称].yml`，如 `1_act2_scorched.yml`。

### **3.2 DungeonsXL 主配置模板**

```yaml
# 焦灼荒地副本主配置
name: “act2_scorched_wastes” # 内部ID，必须唯一
displayName: “<red>焦灼荒地” # 显示名
map: “world_dxl_scorched_template” # 模板世界名
start:
  x: 0
  y: 65
  z: 0
  world: “{DUNGEON}” # 关键变量，代表生成的副本世界
groups:
  party: # 队伍配置
    players: 2-5
    exclusivity: true # 队伍独占
floor: 1
lives: 3
time: 7200
script: act2_scorched_main.dscript # 绑定主脚本
rewards: scorched_rewards
rules: # 副本内游戏规则
  keepInventory: true
  pvp: false
  hunger: false
```

### **3.3 脚本事件命名规范**


| 事件前缀    | 用途         | 示例                                |
| :---------- | :----------- | :---------------------------------- |
| `obj_`      | 主线任务目标 | `obj_collect_metal_fragments`       |
| `event_`    | 场景事件     | `event_defend_beacon`               |
| `wave_`     | 怪物波次     | `wave_final_boss_minions`           |
| `dialog_`   | NPC对话      | `dialog_bren_start`                 |
| `cutscene_` | 过场动画     | `cutscene_memory_flashback`         |
| `choice_`   | 玩家抉择     | `choice_wormling_attack_or_observe` |

---

## **第四章：玩家规则与行为规范**

### **4.1 队伍制度**

* **队长负责制**：队长触发副本创建，拥有将队员踢出副本的权限（需确认）。
* **中途加入**：副本开始15分钟后，禁止新玩家加入。
* **恶意退出惩罚**：非掉线原因，在BOSS战前主动退出副本，该玩家将进入30分钟副本冷却期。

### **4.2 副本内禁止行为**

1. 恶意破坏副本关键建筑（由 `WorldGuard` + `CoreProtect` 记录，严惩）。
2. 利用BUG卡怪物、复制物品（发现即封禁）。
3. 在团队频道进行与副本无关的刷屏、争吵。

### **4.3 奖励分配原则**

* **基础奖励**：人人平等，通关即得。
* **竞拍制度**：BOSS掉落的**稀有职业符文**，采用队伍内金币竞拍，所得平分。
* **贡献加权**：输出、治疗、承伤数据前3名，额外获得“贡献宝箱”，开出材料绑定。

---

## **第五章：监控、维护与应急预案**

### **5.1 管理员监控命令**


| 目的         | 命令                           | 说明                           |
| :----------- | :----------------------------- | :----------------------------- |
| 查看活跃副本 | `/dxl list`                    | 列出所有正在运行的副本         |
| 查看副本详情 | `/dxl info <副本ID>`           | 查看某个副本的队伍、进度、时间 |
| 强制销毁副本 | `/dxl delete <副本ID>`         | 用于处理卡死的副本             |
| 传送至副本   | `/mv tp @self {DUNGEON_WORLD}` | 进入副本世界调试               |

### **5.2 日常维护任务**

1. **每日**：检查数据库 `active_dungeons` 表，清理残留数据。
2. **每周**：重启服务器，确保所有模板世界被正确卸载，释放内存。
3. **每月**：备份所有副本脚本和配置文件。

### **5.3 应急预案**


| 故障场景         | 自动响应                                  | 人工干预                                    |
| :--------------- | :---------------------------------------- | :------------------------------------------ |
| **副本生成失败** | 提示玩家“系统繁忙”，冷却1分钟重试       | 检查模板世界是否被占用，重启DungeonsXL      |
| **BOSS卡住**     | 5分钟无活动，自动重置BOSS血量，传送至起点 | 管理员传送进去，用`/mm m kill` 杀死卡住怪物 |
| **副本无法完成** | 时间耗尽自动传出，发放基础补偿            | 手动检查脚本触发器，补偿玩家进度            |
| **服务器崩溃**   | 重启后，DungeonsXL尝试恢复副本状态        | 如恢复失败，根据日志手动发放补偿            |

### **5.4 性能调优参数** (`config.yml`)

```yaml
dungeonsxl:
  economy:
    # 奖励发放改为异步，防止卡顿
    async-rewards: true
  dungeon:
    # 副本无玩家时，卸载等待时间（秒）
    unload-time: 900 # 15分钟
  script:
    # 脚本执行超时时间，防止死循环
    timeout: 5000
```

---

## **第六章：附录：第二幕四大副本关键参数总表**


| 参数                 | 焦灼荒地                      | 霜语山脉                   | 幽影沼泽                   | 晶化洞窟                     |
| :------------------- | :---------------------------- | :------------------------- | :------------------------- | :--------------------------- |
| **副本ID**           | `act2_scorched`               | `act2_frost`               | `act2_swamp`               | `act2_crystal`               |
| **模板世界**         | `world_dxl_scorched_template` | `world_dxl_frost_template` | `world_dxl_swamp_template` | `world_dxl_crystal_template` |
| **队伍人数**         | 2-5                           | 2-5                        | 2-5                        | 1-3                          |
| **核心机制**         | 环境灼烧、净化守护            | 暴风雪、热能符文           | 毒雾、净化火炬             | 静默力场、道德抉择           |
| **BOSS名称**         | 熔核巨像                      | 霜语巫祝                   | 幽影编织者                 | (无)                         |
| **关键任务物品**     | 净化的能量核心                | 恒温核心碎片               | 净化孢子                   | 纯净的能量结晶               |
| **通关奖励（固定）** | 灼热的记忆残像                | 霜封的记忆残像             | 幽暗的记忆残像             | 蠕虫的鳞片 / 混乱残渣        |
| **建议挑战顺序**     | 2                             | 1                          | 1                          | 4 (最终)                     |

---

这份规范定义了从技术实现到运营管理的全套标准。**下一步的关键行动是**：依据此规范，在测试服上逐一创建四个模板世界，并配置对应的 `DungeonsXL` YAML文件和脚本，进行 **“单区域全流程贯通测试”**，确保从“准入”到“销毁”的每一个环节都如设计般运行。如果需要我为任何一个区域编写完整的、可直接粘贴使用的DungeonsXL配置和Denizen脚本示例，我可以继续为你展开。
