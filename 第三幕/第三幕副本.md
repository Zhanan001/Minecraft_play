# **第三幕：囚徒与狱卒 - 完整副本管理规范**

## **第一章：副本核心定义与分类**

### **1.1 副本类型（按第三幕设计）**


| 类型                 | 对应内容                         | 核心性质                                                           | 玩家准入                                                | 实例模型                   |
| :------------------- | :------------------------------- | :----------------------------------------------------------------- | :------------------------------------------------------ | :------------------------- |
| **剧情高潮副本**     | 地脉核心                         | **高难度团队挑战，剧情核心体验**。非战斗式Boss机制，强调职业协作。 | 3-5人队伍，必须包含所有三种职业（匠师、元术士、狩魂者） | 每个队伍一个独立世界实例   |
| **全服事件型副本**   | 熵灵之心（B线专属）              | **超大规模全服副本，无人数上限**。史诗级最终战，线性协作推进。     | 所有B线玩家，无队伍限制                                 | 单实例多区域分线，动态负载 |
| **阵营专属建筑副本** | 永恒石脉（A线）/ 疯狂虫巢（B线） | **日常资源采集与任务副本**。用于阵营备战。                         | 对应阵营玩家，1-3人小队                                 | 按需生成，15分钟限时       |
| **动态世界事件**     | 增幅塔建造/蠕虫净化仪式          | **开放世界公共事件**。全服玩家参与，进度共享。                     | 对应阵营玩家，无限制                                    | 主世界直接触发，无独立实例 |

### **1.2 副本技术栈扩展**

* **核心插件**：`DungeonsXL` + `Multiverse-Core`（地脉核心）
* **大规模副本**：`MythicMobs` 分区域生成 + `WorldGuard` 分区管理（熵灵之心）
* **全服事件**：`BossBarAPI`（进度显示）+ `HolographicDisplays`（指引）
* **公投系统**：`VotePlugin` + `Towny`（城镇投票权重）+ `DiscordSRV`（实时播报）
* **阵营数据**：`MySQL`（玩家阵营选择记录）+ `LuckPerms`（动态权限组）

---

## **第二章：副本生命周期管理规范**

### **2.1 阶段一：创建与准入**

#### **A. 前置条件检查（地脉核心副本）**

玩家与裂隙传送门交互时，执行检查链：

```yaml
# Denizen脚本：地脉核心准入检查
core_access_check:
  type: world
  debug: false
  events:
    on player right clicks block:end_portal_frame: # 伪装为裂隙传送门
      - if <player.has_permission[act3.core.access]> {
          # 检查队伍职业构成
          - define party <player.party_members>
          - define has_crafter false
          - define has_magus false
          - define has_hunter false
          - foreach <[party]>:
            - if <[value].has_permission[class.crafter]> {
                - define has_crafter true
              }
            - if <[value].has_permission[class.magus]> {
                - define has_magus true
              }
            - if <[value].has_permission[class.hunter]> {
                - define has_hunter true
              }
          - if <[has_crafter]> && <[has_magus]> && <[has_hunter]> && <[party].size> >= 3 && <[party].size> <= 5 {
              - run “dxl play <player> act3_heart_of_the_world”
            }
            else {
              - narrate “<&c>地脉核心需要一支3-5人且包含所有职业的精英队伍。”
            }
          }
        else {
          - narrate “<&c>你尚未获得深入地脉核心的许可。请先与阿尔图交谈。”
        }
```

#### **B. 公投系统准入机制**

```yaml
# 公投参与条件检查
referendum_check:
  type: task
  script:
    # 第43天中午自动触发
    - wait 1t
    - execute as @a[gamemode=survival] run {
        - if <player.has_flag[has_worm_memory_gland]> { # 完成地脉核心
            - flag player can_vote true
            - title <player> title “<yellow>抉择之时已至”
            - title <player> subtitle “<gray>前往方尖碑参与公投”
          }
      }
```

#### **C. 阵营任务准入规则**


| 规则项       | A线（封印派）                          | B线（净化派）                          | 中立/未选择      |
| :----------- | :------------------------------------- | :------------------------------------- | :--------------- |
| **触发条件** | 公投支持A线 + 完成地脉核心             | 公投支持B线 + 完成地脉核心             | 无法接取核心任务 |
| **任务解锁** | 《铸造永恒牢笼》史诗任务               | 《唤醒古老盟约》史诗任务               | 仅限日常资源任务 |
| **副本权限** | 永恒石脉副本（每日3次）                | 疯狂虫巢副本（每日3次）                | 无专属副本       |
| **世界事件** | 增幅塔建造事件（全服）                 | 虫巢净化仪式（全服）                   | 可旁观，无贡献   |
| **隐藏内容** | 失落者任务线（需晶化洞窟选择“观察”） | 保守派任务线（需晶化洞窟选择“攻击”） | 无               |

### **2.2 阶段二：运行与进度管理**

#### **A. 地脉核心副本特殊规则**

* **时间限制**：**90分钟（5400秒）**，更紧凑的体验。
* **生命制度**：**2条团队共享生命**，提高容错要求。
* **进度保存**：
  1. **每个阶段结束**：关闭阀门、调查虫茧、重启拘束器。
  2. **Boss战阶段转换**：70%、40%、10%血量自动保存。
  3. **死亡惩罚**：消耗1条团队生命，在最近保存点复活（有30秒虚弱debuff）。
* **职业协作检查点**：
  - 阀门关闭：需要匠师+元术士协作
  - 虫茧调查：任意职业可交互，但不同职业获得额外线索
  - Boss战阶段：强制要求各职业执行特定机制

#### **B. 熵灵之心副本（B线最终战）管理规范**

```yaml
# 大规模副本配置模板
entropy_heart_config:
  type: dynamic_megadungeon
  max_players: 无上限
  load_balancing: true
  zones:
    - name: corruption_hallway
      max_players_per_instance: 40
      spawn_location: 0, 65, 0
      exit_location: 100, 65, 0 # 连接下一区域
    - name: desire_chamber
      max_players_per_instance: 30
      spawn_location: 100, 65, 0
      boss: false
    - name: throne_core
      max_players_per_instance: 20
      spawn_location: 200, 65, 0
      boss: true
      exclusive: true # 仅允许一支队伍进入Boss房
  
  dynamic_scaling:
    health_multiplier: “1 + (0.02 * online_players)”
    damage_multiplier: “1 + (0.01 * online_players)”
    loot_multiplier: “1 - (0.005 * online_players)” # 避免过度奖励
```

#### **C. 阵营世界事件进度管理**

```yaml
# A线：增幅塔建造进度追踪
tower_progress_tracker:
  type: world
  events:
    on block place:
      - if <context.location.is_within_region[tower_construction_zone]> {
          - if <context.material.name> == “blueprint_block” {
              # 转换为实际方块
              - run setblock <context.location> stone_bricks
              # 增加进度
              - scoreboard players add #tower_a_progress global 1
              # 检查完成度
              - if <server.scoreboard[global].get[#tower_a_progress]> >= 1000 {
                  - broadcast “<green>北境增幅塔建造完成！”
                  - playsound @a entity.elder_guardian.curse
                }
            }
        }
```

### **2.3 阶段三：完成、退出与销毁**

#### **A. 地脉核心完成分支**


| 完成状态     | 触发条件                    | 结果                                 | 影响第三幕后续           |
| :----------- | :-------------------------- | :----------------------------------- | :----------------------- |
| **完美通关** | 击败蠕虫幼体 + 查看记忆腺体 | 获得“蠕虫的记忆腺体”，全队额外奖励 | 解锁与阿尔图的特殊对话   |
| **普通完成** | 击败蠕虫幼体                | 获得基础奖励，无记忆腺体             | 仅有基础任务推进         |
| **失败**     | 团队生命耗尽或超时          | 无奖励，记录失败次数                 | 可立即重试（无冷却）     |
| **中途放弃** | 使用`/dungeon leave`        | 保存个人进度至当前阶段               | 冷却30分钟后方可再次进入 |

#### **B. 阵营任务结算系统**

**A线（封印派）结算**：

1. **四塔建造完成**：全服A线玩家获得“封印奠基人”称号
2. **个人贡献度**：根据资源提交量、建造参与度、防御贡献计算
3. **奖励发放**：阶段性发放（每完成一座塔），最终额外奖励

**B线（净化派）结算**：

1. **40个契约收集完成**：全服B线玩家获得“净化先驱”称号
2. **净化效率**：根据净化速度、契约质量（是否有额外沟通）计算
3. **决战准备度**：护送先知、制造器械等额外贡献

#### **C. 副本销毁与数据归档**

**地脉核心销毁流程**：

1. **数据记录**：将以下数据写入 `player_season_log` 表：

   - 通关时间、队伍成员、消耗生命数
   - 各阶段完成时间、Boss战表现（打断次数、符文柱激活数）
   - 个人选择记录（如有）
2. **世界销毁**：

   - 玩家全部离开后立即卸载
   - 5分钟后删除世界文件夹
   - 但保留数据库记录用于赛季统计

**阵营事件销毁**：

- **增幅塔**：建造完成后变为永久建筑，不销毁
- **虫巢副本**：净化完成后入口消失，世界标记为“已净化区域”
- **隐秘营地**：第三幕结束后保留，作为世界历史痕迹

---

## **第三章：配置与脚本编写规范**

### **3.1 文件结构与命名**

```
plugins/DungeonsXL/
├── dungeons/
│   ├── 3_act3_heart_of_world.yml      # 地脉核心
│   ├── 3_act3_eternal_prison_a.yml    # A线永恒石脉
│   └── 3_act3_madness_nest_b.yml      # B线疯狂虫巢
├── scripts/
│   ├── act3_core_main.dscript          # 地脉核心主流程
│   ├── act3_boss_wormling.dscript      # 蠕虫幼体Boss战
│   ├── act3_referendum.dscript         # 公投系统
│   ├── act3_faction_a_events.dscript   # A线世界事件
│   └── act3_faction_b_events.dscript   # B线世界事件
└── rewards/
    ├── act3_core_rewards.yml
    ├── act3_faction_a_rewards.yml
    └── act3_faction_b_rewards.yml
```

**命名规则**：`[幕次]_[内容]_[阵营(可选)].yml`

### **3.2 DungeonsXL 主配置模板（地脉核心）**

```yaml
name: “act3_heart_of_the_world”
displayName: “<dark_purple>地脉核心·活体监狱”
map: “world_dxl_core_template”
start:
  x: 0
  y: 65
  z: 0
  world: “{DUNGEON}”
groups:
  party:
    players: 3-5
    exclusivity: true
    required_classes: [“crafter”, “magus”, “hunter”] # 职业要求
floor: 1
lives: 2
time: 5400
script: act3_core_main.dscript
rewards: act3_core_rewards
rules:
  keepInventory: true
  pvp: false
  hunger: true # 增加生存压力
  naturalRegeneration: false # 禁用自然回血，鼓励治疗协作
checkpoints:
  - name: after_valves
    location: 0, 25, 0
  - name: after_cocoons
    location: 0, 20, 0
  - name: boss_arena
    location: 0, 10, 0
```

### **3.3 脚本事件命名规范（扩展）**


| 事件前缀        | 用途         | 示例                          |
| :-------------- | :----------- | :---------------------------- |
| `core_`         | 地脉核心专属 | `core_valve_interaction`      |
| `worm_`         | 蠕虫Boss相关 | `worm_phase2_transition`      |
| `vote_`         | 公投系统     | `vote_town_submit`            |
| `faction_a_`    | A线阵营事件  | `faction_a_tower_build`       |
| `faction_b_`    | B线阵营事件  | `faction_b_purify_ritual`     |
| `world_`        | 全服世界事件 | `world_final_countdown`       |
| `choice_final_` | 最终阵营选择 | `choice_final_seal_or_purify` |

### **3.4 公投系统技术实现**

```yaml
# 数据库表设计
tables:
  server_referendum:
    columns:
      - vote_id INT AUTO_INCREMENT PRIMARY KEY
      - player_uuid CHAR(36)
      - town_name VARCHAR(32)
      - vote_choice ENUM('SEAL', 'PURIFY')
      - vote_weight INT DEFAULT 10
      - timestamp DATETIME
      - CONSTRAINT fk_town FOREIGN KEY (town_name) REFERENCES towny_towns(name)

# 投票权重计算函数
calculate_vote_weight:
  type: task
  script:
    - define base_weight 10
    - define town_level <server.towny.get[town_level].for[<player.town>]>
    - define weight <[base_weight]> + (<[town_level]> * 5)
    - if <player.has_flag[completed_core_hardmode]> {
        - define weight <[weight]> + 5
      }
    - define <player.vote_weight> <[weight]>
```

---

## **第四章：玩家规则与行为规范（第三幕特殊条款）**

### **4.1 阵营行为规范**

#### **A. 公投期间（第43-45天）**

1. **辩论区行为**：

   - 允许语言辩论，禁止人身攻击
   - 可使用游戏内告示牌、横幅宣传
   - 禁止堵塞对方辩论区入口
2. **投票诚信**：

   - 镇长必须征询居民意见后投票
   - 发现贿选、威胁等行为，取消该城镇投票资格
   - 投票结果不可更改，请谨慎选择

#### **B. 阵营对抗期（第46-56天）**

1. **冲突规则**：

   - **开放世界PvP**：仅在特定“冲突区域”允许
   - **资源点争夺**：可干扰，但不可完全封锁
   - **建筑破坏**：仅允许破坏临时建筑，永久建筑受保护
2. **间谍行为**：

   - 允许玩家“叛变”阵营（通过特定任务）
   - 但叛变后24小时内无法参与核心任务
   - 禁止使用小号进行间谍活动

### **4.2 副本行为新增条款**

1. **地脉核心协作要求**：

   - 进入前必须明确职责分工
   - 故意不执行职业专属机制视为违规
   - 队长有权踢出不协作队员（需多数队员同意）
2. **阵营副本优先权**：

   - 高峰时段，本阵营玩家优先进入专属副本
   - 敌对阵营玩家可排队，但等待时间较长
   - 管理员可调整比例以平衡体验

### **4.3 奖励分配特殊规则**

**地脉核心奖励**：

- **记忆腺体**：全队共享任务物品，每人自动获得
- **职业符文**：竞拍制度，但增加“职业优先权”：本职业符文竞拍时，该职业玩家出价享受8折优惠
- **贡献奖励**：根据机制执行情况分配（如：成功打断Boss次数、激活符文柱数）

**阵营备战奖励**：

- **建造贡献**：A线根据提交资源量和建造参与度
- **净化效率**：B线根据净化速度和契约质量
- **全服里程碑奖励**：当阵营进度达到25%、50%、75%、100%时，所有参与玩家获得阶段奖励

---

## **第五章：监控、维护与应急预案（第三幕特化）**

### **5.1 管理员监控命令扩展**


| 目的         | 命令                                     | 说明                             |
| :----------- | :--------------------------------------- | :------------------------------- |
| 查看阵营分布 | `/faction stats`                         | 显示A/B线玩家数量、城镇分布      |
| 调整阵营平衡 | `/faction balance [add/remove] [player]` | 手动调整玩家阵营（用于修复bug）  |
| 强制推进事件 | `/event trigger [event_id]`              | 手动触发世界事件（如塔建造完成） |
| 查看公投详情 | `/vote results [detailed]`               | 显示投票详情，包括各城镇选择     |
| 重置阵营进度 | `/faction resetprogress [A/B]`           | 重置阵营任务进度（极端情况使用） |

### **5.2 第三幕特有维护任务**

1. **公投期间**：

   - 每2小时备份投票数据库
   - 监控辩论区聊天，及时处理冲突
   - 确保投票网站/插件稳定运行
2. **阵营对抗期**：

   - 每日检查阵营任务进度平衡
   - 监控冲突区域PvP频率，调整规则
   - 清理被放弃的临时建筑
3. **事件转换时**：

   - 公投结果公布后，立即执行阵营分配脚本
   - 阵营分配后，验证所有玩家权限正确更新
   - 备份转换前的世界状态（以防回滚需要）

### **5.3 应急预案（第三幕特化）**


| 故障场景                   | 自动响应                               | 人工干预                                 |
| :------------------------- | :------------------------------------- | :--------------------------------------- |
| **公投数据不一致**         | 锁定投票系统，发出警告                 | 从备份恢复，延长投票时间24小时           |
| **阵营分配错误**           | 错误玩家无法接取任务                   | 手动调整阵营，补偿受影响玩家             |
| **阵营进度严重失衡**       | 弱势阵营获得临时buff（资源获取+20%）   | 调整任务难度或增加额外事件               |
| **地脉核心Boss机制失效**   | 强制重置Boss至最近阶段                 | 传送队伍出副本，发放补偿，修复后重置副本 |
| **全服事件卡住**           | 事件开始1小时后无进展，自动提供NPC帮助 | 管理员介入，手动推进或重置事件           |
| **服务器崩溃导致进度丢失** | 重启后尝试从数据库恢复进度             | 根据日志手动恢复，发放全服补偿           |

### **5.4 性能调优参数（第三幕特化）**

```yaml
# config.yml 第三幕专用配置段
act3_performance:
  # 地脉核心副本
  heart_of_world:
    max_concurrent_instances: 10 # 同时最多10个队伍
    monster_cap_per_instance: 30 # 每个副本最多30只怪
  
  # 阵营世界事件
  faction_events:
    max_particles_per_event: 5000 # 全事件粒子总数上限
    dynamic_load_balancing: true
    player_threshold_for_division: 30 # 超过30人自动分线
  
  # 公投系统
  referendum:
    cache_vote_results: true
    save_interval_seconds: 60 # 每60秒保存一次投票数据
  
  # 内存管理
  memory:
    unload_inactive_faction_zones: true
    inactive_time_minutes: 30
    preload_important_zones: [“obelisk_area”, “faction_hubs”]
```

### **5.5 数据备份策略**

```yaml
backup_schedule:
  # 关键时间点备份
  - trigger: before_referendum
    name: “pre_referendum_backup”
    include: [“player_data”, “towny_data”, “world_obelisk_region”]
  
  - trigger: referendum_result_announced
    name: “post_referendum_backup”
    include: [“referendum_votes”, “player_faction_assignment”]
  
  - trigger: act3_completed
    name: “end_of_act3_backup”
    include: [“all_player_progress”, “faction_achievements”, “world_changes”]
  
  # 日常备份
  daily:
    time: “03:00”
    retain: 7 # 保留7天
```

---

## **第六章：附录：第三幕关键参数总表**

### **6.1 副本参数总表**


| 参数         | 地脉核心                  | 永恒石脉（A线）           | 疯狂虫巢（B线）           | 熵灵之心（B线最终）          |
| :----------- | :------------------------ | :------------------------ | :------------------------ | :--------------------------- |
| **副本ID**   | `act3_heart_of_world`     | `act3_eternal_mine_a`     | `act3_madness_nest_b`     | `act3_entropy_heart`         |
| **模板世界** | `world_dxl_core_template` | `world_dxl_mine_template` | `world_dxl_nest_template` | `world_dxl_entropy_template` |
| **队伍人数** | 3-5（全职业）             | 1-3                       | 1-3                       | 无上限，动态分线             |
| **时间限制** | 90分钟                    | 15分钟                    | 15分钟                    | 无限制（事件驱动）           |
| **团队生命** | 2                         | 1（个人）                 | 1（个人）                 | 无限（检查点复活）           |
| **准入条件** | 完成第二幕四区域          | A线阵营，个人任务         | B线阵营，个人任务         | B线阵营，完成40契约          |
| **核心机制** | 职业协作打断、符文柱激活  | 采矿+防御、石噬虫干扰     | 净化仪式、精神抗性        | 欲望复制、过载机制           |
| **奖励类型** | 记忆腺体、职业史诗符文    | 永恒石、禁锢合金材料      | 纯净契约、安抚合剂材料    | 纪元之种、光翼幻化           |

### **6.2 世界事件参数总表**


| 参数         | 增幅塔建造（A线）        | 虫巢净化仪式（B线）  | 护送先知（B线）  | 最终注能事件（A线）    |
| :----------- | :----------------------- | :------------------- | :--------------- | :--------------------- |
| **事件类型** | 建造（资源+放置）        | 仪式（QTE+引导）     | 护送（移动防御） | 引导（协同防御）       |
| **参与人数** | 全服A线玩家              | 1-3人小队副本        | 3-8人推荐        | 全服A线玩家（多队伍）  |
| **持续时间** | 7天（现实）              | 5-10分钟             | 15-20分钟        | 10分钟（严格时限）     |
| **失败条件** | 7天内未完成4塔           | 仪式中断3次/超时     | 先知死亡         | 任何一塔引导归零       |
| **成功奖励** | 封印奠基人称号、专属幻化 | 纯净契约、个人声望   | 大量准备度、装备 | 永恒监牢完成，世界变化 |
| **全局影响** | 四塔矗立，世界屏障       | 契约计数，决战准备度 | 准备度大幅增加   | 封印完成，进入A线结局  |

### **6.3 公投系统参数**


| 参数         | 值                           | 说明                      |
| :----------- | :--------------------------- | :------------------------ |
| **投票时间** | 48小时（现实）               | 第44天12:00 - 第46天12:00 |
| **投票权重** | 城镇基础票10 + 等级×5       | 鼓励团队协作与城镇发展    |
| **计票方式** | 城镇票数制，镇长代表         | 体现集体决策              |
| **公布仪式** | 第46天12:00，方尖碑现场      | 全服传送，盛大仪式        |
| **结果锁定** | 公布后立即生效，不可更改     | 世界状态立即改变          |
| **败者选项** | 接受结果 / 成为失落者/保守派 | 个人选择，影响隐藏任务    |

### **6.4 性能与容量规划**


| 资源类型         | 第三幕预估需求        | 监控阈值  | 自动响应             |
| :--------------- | :-------------------- | :-------- | :------------------- |
| **同时副本数**   | 峰值20个（核心+阵营） | 25个      | 队列系统启动         |
| **全服事件玩家** | 峰值100人参与         | 150人     | 动态分线，降低特效   |
| **数据库写入**   | 公投期间高频          | 每秒100次 | 缓存队列，批量写入   |
| **内存使用**     | 增加20-30%            | 80%占用率 | 提前卸载非活动副本   |
| **带宽需求**     | 增加（粒子、音效）    | 90%利用率 | 降低非关键粒子密度   |
| **存储空间**     | 新增50-100GB（建筑）  | 85%使用率 | 清理旧日志，压缩备份 |

---

## **第七章：第三幕上线检查清单**

### **7.1 上线前（第36天前）**

**基础设施**：

- [ ]  数据库表创建完成（`referendum_votes`, `faction_progress`, `act3_player_choices`）
- [ ]  所有模板世界搭建完成并通过测试
- [ ]  DungeonsXL配置文件和脚本编写完成
- [ ]  资源包更新（阵营特效、新怪物模型）

**内容验证**：

- [ ]  地脉核心全流程测试（至少3次不同职业组合）
- [ ]  公投系统压力测试（模拟50城镇同时投票）
- [ ]  阵营任务平衡测试（A/B线各完成一次全流程）
- [ ]  应急预案演练（模拟各种故障场景）

**社区准备**：

- [ ]  发布第三幕预告和规则说明
- [ ]  镇长培训：投票流程和职责
- [ ]  Discord频道准备（#debate-seal, #debate-purify）
- [ ]  客服团队培训（应对阵营相关咨询）

### **7.2 上线中（第36-56天）**

**每日检查**：

- [ ]  阵营进度平衡情况（差异<15%为健康）
- [ ]  副本排队情况（平均等待时间<5分钟）
- [ ]  玩家反馈收集（重点：阵营公平性）
- [ ]  数据库备份验证

**关键节点**：

- [ ]  第36天：地脉核心开放，监控难度反馈
- [ ]  第43天：公投开始，确保投票系统稳定
- [ ]  第46天：阵营分裂，验证权限正确分配
- [ ]  第50-56天：阵营任务期，监控进度平衡

### **7.3 结束后（第56天后）**

**数据归档**：

- [ ]  导出第三幕完整统计数据
- [ ]  备份玩家最终阵营状态
- [ ]  保存世界建筑状态（增幅塔、净化区域）
- [ ]  生成第三幕总结报告

**资源回收**：

- [ ]  卸载并删除所有临时副本世界
- [ ]  清理不再需要的数据库临时表
- [ ]  回收测试用资源，准备第四幕

**社区过渡**：

- [ ]  发布第三幕数据统计（有趣的事实）
- [ ]  预告第四幕内容（根据阵营选择）
- [ ]  收集玩家反馈，用于赛季总结
- [ ]  举办第三幕结束纪念活动

---

**此规范文档为第三幕“囚徒与狱卒”的完整副本与事件管理框架。重点在于处理从团队副本到全服事件再到阵营对立的复杂过渡，确保技术稳定性和玩家体验的公平性。建议在实际部署前，在测试服完整运行至少一个完整周期（21天），以验证所有系统和平衡性。**
